# Agent Instructions for `awscdk-basic-serverless-webapi`

This document provides essential guidelines, commands, and conventions for AI agents working on this AWS CDK project.

## Project Overview

- **Technology Stack**: AWS CDK v2, TypeScript, Node.js.
- **Purpose**: A serverless Web API infrastructure including VPC, Fargate, RDS, and Load Balancer.
- **Package Manager**: `pnpm` (Primary package manager. Ensure `pnpm-lock.yaml` is respected).

## 1. Development Commands

### Build & Compilation

- **Compile TypeScript**: `pnpm build`
- **Watch mode**: `pnpm watch`

### Testing (Jest)

- **Run all tests**: `pnpm test`
- **Run a single test file**: `pnpm exec jest test/app.test.ts`
- **Run with coverage**: `pnpm exec jest --coverage`
- **Update snapshots**: `pnpm exec jest -u`

### AWS CDK Commands

- **Synthesize CloudFormation**: `pnpm exec cdk synth`
- **Check differences**: `pnpm exec cdk diff`
- **Deploy stack**: `pnpm exec cdk deploy`
- **List stacks**: `pnpm exec cdk ls`

## 2. Directory Structure

- `bin/`: Application entry point (`app.ts`).
- `lib/`: Main stack definitions.
- `lib/constructs/`: Modularized L2/L3 constructs (VPC, RDS, Fargate, etc.).
- `lib/settings.ts`: Configuration constants and environment variable mappings.
- `test/`: Infrastructure tests using `@aws-cdk/assertions`.

## 3. Code Style & Conventions

### Imports

- **Grouping**: Group imports in the following order, separated by a blank line:
  1. AWS CDK libraries (`import * as cdk from 'aws-cdk-lib'`)
  2. Third-party libraries (`import { Construct } from 'constructs'`)
  3. Local constructs and modules
  4. Local settings/constants
- **Namespace Imports**: Prefer `import * as ec2 from 'aws-cdk-lib/aws-ec2'` for CDK modules to keep the code readable and consistent with existing files.

### Naming Conventions

- **Classes/Constructs**: `PascalCase` (e.g., `VpcSubnets`, `FargateService`).
- **Variables/Instances**: `camelCase` (e.g., `appSecurityGroup`, `dbCluster`).
- **Interfaces/Props**: `PascalCase` named as `Props` within the file or `[ClassName]Props`.
- **Constants**: `SCREAMING_SNAKE_CASE` (e.g., `APP_PORT`, `USE_NAT_GATEWAY`).

### TypeScript Usage

- **Strict Typing**: Always define interfaces for construct props.
- **Public/Private**: Explicitly mark construct members as `public readonly` if they need to be accessed by other constructs.
- **Initialization**: Prefer constructor-based initialization of resources.

### AWS CDK Patterns

- **Construct Granularity**: Break down large stacks into smaller, reusable `Construct` classes located in `lib/constructs/`.
- **Dependency Management**: Use `node.addDependency()` only when implicit dependencies (e.g., passing a resource to another) are insufficient.
- **Security Groups**: Manage ingress/egress rules as close to the resource definition as possible, or within the `SecurityGroups` construct.
- **Tags**: Apply standard tags at the stack level in `lib/app-stack.ts`.

## 4. Resource Specific Guidelines

### VPC & Networking

- Always define explicit subnet configurations (Public, App, Db).
- Use `ec2.SubnetType.PRIVATE_ISOLATED` for databases.
- Use `ec2.SubnetType.PRIVATE_WITH_EGRESS` for application logic if a NAT Gateway is available.

### RDS (Relational Database Service)

- Use `aws-cdk-lib/aws-rds` for Aurora/RDS clusters.
- Store credentials in AWS Secrets Manager (standard CDK behavior).
- Ensure the database is placed in the `Db` subnet group.

### ECS/Fargate

- Use `ApplicationLoadBalancedFargateService` or manual `FargateService` depending on the complexity.
- Map environment variables from `settings.ts`.

## 5. Testing Policy

- **Assertions**: Use `Template.fromStack(stack)` and `template.hasResourceProperties()` to verify infrastructure.
- **Fine-grained Tests**: Write tests for individual constructs in `lib/constructs/` when logic involves conditions or loops.

## 6. Error Handling & Validation

- **Input Validation**: Validate props in the construct constructor (e.g., checking CIDR formats or port ranges).
- **Graceful Failures**: Provide sensible defaults for optional props using the `??` or `||` operators.

## 7. Security Best Practices

- **No Secrets**: Never hardcode API keys, passwords, or tokens. Use `settings.ts` to map environment variables.
- **Least Privilege**: Grant minimum required permissions for IAM roles.
- **Encryption**: Enable encryption for RDS and S3 resources by default.

---

_Note: This file is automatically generated for AI agents. Please update it if project conventions change._
