@page "/todo"
@using DotNetGrpc.Shared
@using Grpc.Net.Client
@inject DotNetGrpc.Shared.Todo.TodoClient TodoClient

<PageTitle>Todo List</PageTitle>

<h1>Todo List</h1>

<p>
    <input @bind="newTodoTitle" placeholder="Enter new todo title" />
    <button class="btn btn-primary" @onclick="AddTodo">Add Todo</button>
</p>

@if (todos == null)
{
    <p><em>Loading...</em></p>
}
else
{
    <table class="table">
        <thead>
            <tr>
                <th>Done</th>
                <th>Title</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var todo in todos)
            {
                <tr>
                    <td>
                        <input type="checkbox" checked="@todo.IsCompleted" @onchange="() => ToggleTodo(todo)" />
                    </td>
                    <td>
                        <input class="form-control" @bind="todo.Title" style="@(todo.IsCompleted ? "text-decoration: line-through;" : "")" />
                    </td>
                    <td>
                        <button class="btn btn-sm btn-success" @onclick="() => UpdateTodo(todo)">Update</button>
                        <button class="btn btn-sm btn-danger" @onclick="() => DeleteTodo(todo)">Delete</button>
                    </td>
                </tr>
            }
        </tbody>
    </table>
}

@if (!string.IsNullOrEmpty(error))
{
    <p class="text-danger">@error</p>
}

@code {
    private List<TodoItem> todos;
    private string newTodoTitle = "";
    private string error = "";

    protected override async Task OnInitializedAsync()
    {
        await LoadTodos();
    }

    private async Task LoadTodos()
    {
        try
        {
            var response = await TodoClient.GetTodosAsync(new EmptyRequest());
            todos = response.Items.ToList();
            error = "";
        }
        catch (Exception ex)
        {
            error = $"Error loading todos: {ex.Message}";
        }
    }

    private async Task AddTodo()
    {
        if (string.IsNullOrWhiteSpace(newTodoTitle)) return;

        try
        {
            await TodoClient.AddTodoAsync(new AddTodoRequest { Title = newTodoTitle });
            newTodoTitle = "";
            await LoadTodos();
        }
        catch (Exception ex)
        {
            error = $"Error adding todo: {ex.Message}";
        }
    }

    private async Task ToggleTodo(TodoItem item)
    {
        try
        {
            await TodoClient.ToggleTodoAsync(new ToggleTodoRequest { Id = item.Id });
            await LoadTodos();
        }
        catch (Exception ex)
        {
            error = $"Error toggling todo: {ex.Message}";
        }
    }

    private async Task UpdateTodo(TodoItem item)
    {
        try
        {
            await TodoClient.UpdateTodoAsync(new UpdateTodoRequest { Id = item.Id, Title = item.Title });
            await LoadTodos();
        }
        catch (Exception ex)
        {
            error = $"Error updating todo: {ex.Message}";
        }
    }

    private async Task DeleteTodo(TodoItem item)
    {
        try
        {
            await TodoClient.DeleteTodoAsync(new DeleteTodoRequest { Id = item.Id });
            await LoadTodos();
        }
        catch (Exception ex)
        {
            error = $"Error deleting todo: {ex.Message}";
        }
    }
}
